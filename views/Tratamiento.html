<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagina Principal Doctor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&family=Figtree:ital,wght@0,300..900;1,300..900&family=Marmelad&family=McLaren&family=Mona+Sans:ital,wght@0,200..900;1,200..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+KR:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Sora:wght@100..800&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
    
    /* Reset básico */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background-color: #F2E6CF;
    font-family: "Sora", sans-serif;
}

header {
    background-color: #114c5f;
    margin: 10px;
    border-radius: 20px;
}

.head {
    display: flex;
    align-items: center;
    padding: 20px;
}

.head img {
    width: 80px;
    height: auto;
    margin-left: 40px;
}
.head h1{
  color: white;
    font-size: 25px;
    margin: 0 40px;
    transition: color 0.3s ease;

}
.head h2 {
    color: white;
    font-size: 16px;
    margin: 0 40px;
    transition: color 0.3s ease;
}
.head h2:hover{
    color: #91CBD6;
}
.head button{
    margin: 0px;
    padding: 15px ;
    border-radius: 10px;
    background-color: #9Cd2d3;
    color: #114c5f;
    border: none;
}
.head button:hover{
    cursor: pointer;
    color: red;
}
.tex {
    display: flex;
}
a {
    text-decoration: none;
}
.bbs{
  display: flex;
}
.bs{
  width: 70%;
  display: flex;
  flex-direction: column;
  margin-top: 40px;
}
.botones{
  display: flex;
  justify-content: space-evenly;
}
.botones a{
  text-decoration: none;
  color: #114c5f;
  font-size: 20px;
}
.section2{
  width: 150px;
  text-align: center;
  height: 130px;
  background-color: #9cd2d3;
  border-radius: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.fondo{
  background: linear-gradient(to bottom, #114c5f 0%, #254B5E 38%, #1b7693 100%);
  width: 180px;
  height: 150px;
  align-items: center;
  justify-content: center;
  display: flex;
  border-radius: 20px;  
}
.tabla {
  background-color: #f5ecd9; /* Color de fondo beige claro */
  padding: 20px;
  border-radius: 10px;
  width: fit-content;
  margin: 20px auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.table-container {
  overflow-x: auto;
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 800px;
  background-color: white;
  border-radius: 10px;
  overflow: hidden;
}

thead {
  background-color: #a3cdd1; /* Azul verdoso suave */
  color: #1b2b33;
}

thead th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
}

tbody td {
  padding: 12px 16px;
  border-top: 1px solid #ddd;
  color: #333;
}
.ss{
  width: 30%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.nota{
  width: 70%;
  height: 150px;
  display: flex;
  justify-content:center ;
  align-items: center;
  background-color: #9cd2d3;
  margin-top: 50px;
  border-radius: 50px;
}
.nota {
   color: #114c5f;
   font-size: 20px;
}
.sele{
  margin-top: 40px;
}
select{
  border: none;
  background-color: #114c5f;
  width: 200px;
  height: 50px;
  border-radius: 20px;
  color: white;
}
.salir{
  width: 40%;
  height: 50px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20%;
  background-color: #114c5f;
  border-radius: 20px;
}
.salir a{
  color: white;
}
.salir:hover{
  background-color: #9cd2d3;
}
@media (max-width: 1024px) {
  .head {
    flex-direction: column;
    text-align: center;
  }

  .head img {
    margin: 0 auto;
  }

  .tex {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .botones {
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }

  .fondo {
    width: 140px;
    height: 130px;
  }

  .section2 {
    width: 100%;
    height: 100%;
    font-size: 16px;
  }

  .bbs {
    flex-direction: column;
    align-items: center;
  }

  .bs, .ss {
    width: 100%;
    align-items: center;
  }

  .nota {
    width: 80%;
    font-size: 16px;
  }

  .salir {
    width: 50%;
  }

  table {
    min-width: 600px;
  }
}

@media (max-width: 600px) {
  .section2 {
    font-size: 14px;
  }

  .botones a {
    font-size: 16px;
  }

  thead th,
  tbody td {
    padding: 10px;
    font-size: 14px;
  }

  .nota a {
    font-size: 16px;
  }

  .salir {
    width: 70%;
  }
}

@media (min-width: 1440px) {
  .tabla {
    max-width: 1200px;
    margin: 20px auto;
  }

  .head {
    max-width: 1400px;
    margin: 10px auto;
  }

  .bbs {
    max-width: 1400px;
    margin: 0 auto;
  }
}

    </style>
</head>
<body>
    <header>
        <div class="head">
            <div class="Ima">
                <img src="img/Solo-Logo.png" alt="">
            </div>
            <div class="tex">
              <h1>Bienvenido Doctor</h1>
              <a href="Doctor.html"><h2 class="hov">Pagina Principal</h2></a>  
              <h2 class="un">Tratamiento del Paciente</h2>
                <a href="Historial.html"><h2>Historial</h2></a>
            </div>
            <button id="logoutBtn"><h3>Cerrar sesión</h3></button>
        </div>
    </header>
    <div class="bbs">
  <div class="bs">
    <div class="botones">
      <div class="fondo">
        <a href="ATrat.html" class="section2">
        <p>Añadir</p>
        </a>
      </div>
    
          </div>
        <div class="tabla">
          <div class="table-container">
            <table>
                <thead>
  <tr>  
    <th>Nombre del paciente</th>
   <th>Nombre del medicamento</th>
    <th>Forma Forma farmacéutica</th>
    <th>Dosis</th>
    <th>Vía de administración</th>
    <th>Frecuencia</th>
    <th>Concentración</th>
    <th>Días de aplicación</th> 
    <th>Eliminar</th> 
    <th>Modificar</th> 
  
  
  </tr>
</thead>

                <tbody id="tabla-citas">
                    <!-- Las citas se llenarán dinámicamente -->
                </tbody>
            </table>
        </div>
        </div>
  </div>
  <div class="ss">
      
      <div class="sele">
        <select name="" id="selectPacientes">
          <option value="" disabled selected>Pacientes</option>
        </select>
      </div>
  </div>
</div>

<script src="js/tratamiento.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  deleteDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAofOyGzsSWHQG3FfsFrGbVWjW0xMywb9c",
  authDomain: "doctrack-46fc2.firebaseapp.com",
  projectId: "doctrack-46fc2",
  storageBucket: "doctrack-46fc2.appspot.com",
  messagingSenderId: "865552814891",
  appId: "1:865552814891:web:cf8e79d5ffd847067bab6e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const tabla = document.getElementById("tabla-citas");
const selectPacientes = document.getElementById("selectPacientes");
const logoutBtn = document.getElementById("logoutBtn");

let tratamientos = [];
let pacientes = {};

function crearInput(valor) {
  const input = document.createElement("input");
  input.type = "text";
  input.value = valor;
  input.style.width = "100px";
  return input;
}

function pintarTabla(pacienteId) {
  tabla.innerHTML = "";

  const filtrados = tratamientos.filter(t => t.data.paciente === pacienteId);

  if (filtrados.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 10;
    td.textContent = "Este paciente no tiene tratamientos.";
    td.style.textAlign = "center";
    tr.appendChild(td);
    tabla.appendChild(tr);
    return;
  }

  filtrados.forEach(({ id, data }) => {
    const row = document.createElement("tr");
    row.style.fontFamily = "Sora, sans-serif";

    const campos = [
      data.medicamento,
      data.forma,
      data.dosis,
      data.via,
      data.frecuencia,
      data.concentracion,
      data.dias
    ];

    const tdPaciente = document.createElement("td");
    tdPaciente.textContent = pacientes[data.paciente] || "Desconocido";
    row.appendChild(tdPaciente);

    const tdCampos = campos.map(valor => {
      const td = document.createElement("td");
      td.textContent = valor;
      return td;
    });

    tdCampos.forEach(td => row.appendChild(td));

    // Eliminar
    const tdEliminar = document.createElement("td");
    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "❌";
    btnEliminar.title = "Eliminar tratamiento";
    btnEliminar.style.cssText = `
      background:#ff4d4d;
      color:white;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-size:16px;
    `;
    btnEliminar.addEventListener("click", async () => {
      if (confirm("\u00bfEliminar este tratamiento?")) {
        await deleteDoc(doc(db, "tratamientos", id));
        alert("Tratamiento eliminado");
        location.reload();
      }
    });
    tdEliminar.appendChild(btnEliminar);
    row.appendChild(tdEliminar);

    // Editar
    const tdModificar = document.createElement("td");
    const btnEditar = document.createElement("button");
    btnEditar.textContent = "✏️";
    btnEditar.title = "Editar tratamiento";
    btnEditar.style.cssText = `
      background:#ffd966;
      color:black;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-size:16px;
    `;
    tdModificar.appendChild(btnEditar);
    row.appendChild(tdModificar);

    btnEditar.addEventListener("click", () => {
      const inputs = [];
      tdCampos.forEach((td) => {
        const input = crearInput(td.textContent);
        td.innerHTML = "";
        td.appendChild(input);
        inputs.push(input);
      });

      tdModificar.innerHTML = "";

      const btnGuardar = document.createElement("button");
      btnGuardar.textContent = "💾";
      btnGuardar.style.marginRight = "8px";

      const btnCancelar = document.createElement("button");
      btnCancelar.textContent = "❌";

      tdModificar.appendChild(btnGuardar);
      tdModificar.appendChild(btnCancelar);

      btnGuardar.addEventListener("click", async () => {
        const [medicamento, forma, dosis, via, frecuencia, concentracion, dias] = inputs.map(i => i.value.trim());

        if (!medicamento || !forma || !dosis || !via || !frecuencia || !concentracion || !dias) {
          alert("Todos los campos son obligatorios.");
          return;
        }

        try {
          await updateDoc(doc(db, "tratamientos", id), {
            medicamento, forma, dosis, via, frecuencia, concentracion, dias
          });
          alert("Tratamiento actualizado correctamente.");
          pintarTabla(pacienteId);
        } catch (e) {
          alert("Error al guardar.");
          console.error(e);
        }
      });

      btnCancelar.addEventListener("click", () => pintarTabla(pacienteId));
    });

    tabla.appendChild(row);
  });
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const doctorId = user.uid;

  const snapPac = await getDocs(query(
    collection(db, "usuarios"),
    where("rol", "==", "paciente"),
    where("assignedDoctor", "==", doctorId)
  ));

  selectPacientes.innerHTML = `<option value="" selected disabled>Selecciona paciente</option>`;
  pacientes = {};

  snapPac.forEach(p => {
    const d = p.data();
    pacientes[p.id] = `${d.nombre} ${d.paterno} ${d.materno}`;
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = pacientes[p.id];
    selectPacientes.appendChild(opt);
  });

  const snapTrat = await getDocs(collection(db, "tratamientos"));
  tratamientos = snapTrat.docs.map(doc => ({ id: doc.id, data: doc.data() }));

  if (selectPacientes.options.length > 1) {
    selectPacientes.selectedIndex = 1;
    pintarTabla(selectPacientes.value);
  }

  selectPacientes.addEventListener("change", () => {
    pintarTabla(selectPacientes.value);
  });
});

if (logoutBtn) {
  logoutBtn.addEventListener("click", async () => {
    const confirmar = confirm("\u00bfEstás seguro de que deseas cerrar sesión?");
    if (!confirmar) return;

    try {
      await signOut(auth);
      alert("Sesión cerrada correctamente.");
      window.location.href = "index.html";
    } catch (error) {
      console.error("Error al cerrar sesión:", error);
      alert("Hubo un error al cerrar sesión.");
    }
  });
}
</script>


</body>
</html>
