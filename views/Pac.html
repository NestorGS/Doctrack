<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocTrack</title>
  <link rel="stylesheet" href="css/Pac.css">
</head>
<body>
  <header>
    <img src="img/Captura_de_pantalla_2024-10-15_010848-removebg-preview.png" alt="">
  </header>

  <div class="container">
    <h2>Bienvenidos A DocTrack</h2>
    <div class="bs">
      <div class="formu">
        <button class="info-button" onclick="toggleForm()">Informaci√≥n Personal</button>
        <div class="form-container" id="formPersonal">
          <input type="text" id="nombre" placeholder="Nombre(s)">
          <input type="text" id="paterno" placeholder="Apellido Paterno">
          <input type="text" id="materno" placeholder="Apellido Materno">
          <input type="text" id="curp" placeholder="CURP">
          <input type="date" id="nacimiento" placeholder="Fecha de Nacimiento">
          <input type="email" id="correo" placeholder="Correo Electr√≥nico">
          <input type="password" id="password" placeholder="Contrase√±a">
          <input type="password" id="confirmar" placeholder="Confirmar Contrase√±a">
        </div>

        <!-- Bot√≥n de registro con reCAPTCHA -->
        <button
          id="registrarBtn"
          class="g-recaptcha btn"
          data-sitekey="6Ld6tXMrAAAAAIx70U-AI9qIRiICO7fSO1Zuqzkg"
          data-callback="onSubmit"
          data-action="submit">Registrarse</button>

        <a href="index.html">
          <div class="reg">
            <h3>Regresar</h3>
          </div>
        </a>
      </div>
    </div>
  </div>

  <script>
    function toggleForm() {
      const form = document.getElementById("formPersonal");
      if (form.style.display === "none" || form.style.display === "") {
        form.style.display = "block";
        setTimeout(() => {
          form.style.opacity = "1";
          form.style.maxHeight = "500px";
        }, 10);
      } else {
        form.style.opacity = "0";
        form.style.maxHeight = "0";
        setTimeout(() => {
          form.style.display = "none";
        }, 500);
      }
    }

    function onSubmit(token) {
      if (typeof registrarPaciente === 'function') {
        registrarPaciente();
      }
    }
  </script>

  <script type="module">
    import { initializeApp, getApps, initializeApp as initApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAofOyGzsSWHQG3FfsFrGbVWjW0xMywb9c",
      authDomain: "doctrack-46fc2.firebaseapp.com",
      projectId: "doctrack-46fc2",
      storageBucket: "doctrack-46fc2.firebasestorage.app",
      messagingSenderId: "865552814891",
      appId: "1:865552814891:web:cf8e79d5ffd847067bab6e",
      measurementId: "G-XQPNKXK08Y"
    };

    const mainApp = initializeApp(firebaseConfig);
    const db = getFirestore(mainApp);
    const mainAuth = getAuth(mainApp);

    const secondApp = getApps().find(app => app.name === "Secondary") || initApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondApp);

    async function asignarPacienteADoctor(doctorId, pacienteId) {
      const doctorRef = doc(db, "doctores", doctorId);
      await updateDoc(doctorRef, {
        [`pacientes.${pacienteId}`]: true
      });
    }

    async function registrarPaciente() {
      const nombre = document.getElementById("nombre").value.trim();
      const paterno = document.getElementById("paterno").value.trim();
      const materno = document.getElementById("materno").value.trim();
      const correo = document.getElementById("correo").value.trim();
      const curp = document.getElementById("curp")?.value.trim() || "sin-curp";
      const nacimiento = document.getElementById("nacimiento")?.value || "2000-01-01";
      const password = document.getElementById("password").value;
      const confirmar = document.getElementById("confirmar").value;

      if (!nombre || !paterno || !materno || !correo || !password || !confirmar) {
        return alert("‚ö†Ô∏è Todos los campos son obligatorios.");
      }

      if (password !== confirmar) {
        return alert("‚ö†Ô∏è Las contrase√±as no coinciden.");
      }

      if (!mainAuth.currentUser) {
        return alert("‚ö†Ô∏è No hay un doctor autenticado.");
      }

      try {
        const doctorId = mainAuth.currentUser.uid;

        const cred = await createUserWithEmailAndPassword(secondaryAuth, correo, password);
        const pacienteId = cred.user.uid;

        await sendEmailVerification(cred.user);

        await setDoc(doc(db, "usuarios", pacienteId), {
          nombre,
          paterno,
          materno,
          correo,
          curp,
          nacimiento,
          rol: "paciente",
          assignedDoctor: doctorId
        });

        await asignarPacienteADoctor(doctorId, pacienteId);
        await signOut(secondaryAuth);

        // Guardar datos para reenviar
        localStorage.setItem("correoPendiente", correo);
        localStorage.setItem("claveTemporal", password);

        // Mostrar modal
        const popup = document.createElement("div");
        popup.style.position = "fixed";
        popup.style.top = "0";
        popup.style.left = "0";
        popup.style.width = "100%";
        popup.style.height = "100%";
        popup.style.background = "rgba(0,0,0,0.8)";
        popup.style.display = "flex";
        popup.style.flexDirection = "column";
        popup.style.justifyContent = "center";
        popup.style.alignItems = "center";
        popup.style.zIndex = "9999";

        const msg = document.createElement("div");
        msg.style.background = "#fff";
        msg.style.padding = "30px";
        msg.style.borderRadius = "10px";
        msg.style.textAlign = "center";
        msg.style.maxWidth = "400px";
        msg.innerHTML = `
          <h2>Verifica tu correo electr√≥nico</h2>
          <p>Hemos enviado un enlace de verificaci√≥n a <strong>${correo}</strong>.</p>
          <p>Una vez confirmado, podr√°s iniciar sesi√≥n en DocTrack.</p>
          <button id="btnReenviarCorreo" style="margin-top: 20px; padding: 10px 20px; background: #114c5f; color: white; border: none; border-radius: 8px; cursor: pointer;">üì© Reenviar correo</button>
        `;

        popup.appendChild(msg);
        document.body.appendChild(popup);

        // Funci√≥n del bot√≥n de reenv√≠o
        document.getElementById("btnReenviarCorreo").addEventListener("click", async () => {
          const email = localStorage.getItem("correoPendiente");
          const clave = localStorage.getItem("claveTemporal");

          if (!email || !clave) return alert("‚ùå No se pudo reenviar: datos incompletos.");

          try {
            const credTemp = await signInWithEmailAndPassword(secondaryAuth, email, clave);
            await sendEmailVerification(credTemp.user);
            await signOut(secondaryAuth);
            alert("üì© Correo reenviado. Revisa tu bandeja de entrada.");
          } catch (err) {
            alert("‚ùå No se pudo reenviar: " + err.message);
          }
        });

      } catch (error) {
        console.error("‚ùå Error al registrar paciente:", error);
        alert("‚ùå Registro fallido. Intenta nuevamente.");
      }
    }

    window.registrarPaciente = registrarPaciente;
  </script>
</body>
</html>
