<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocTrack</title>
    <link rel="stylesheet" href="css/Pac.css">
</head>
<body>
        <header><img src="img/Captura_de_pantalla_2024-10-15_010848-removebg-preview.png" alt=""></header>

    <div class="container">
        <h2>Bienvenidos A DocTrack</h2>
        <div class="bs">
        <div class="formu">
        <button class="info-button" onclick="toggleForm()">Información Personal</button>
        <div class="form-container" id="formPersonal">
           <input type="text" id="nombre" placeholder="Nombre(s)">
<input type="text" id="paterno" placeholder="Apellido Paterno">
<input type="text" id="materno" placeholder="Apellido Materno">
<input type="text" id="curp" placeholder="CURP">
<input type="date" id="nacimiento" placeholder="Fecha de Nacimiento">
<input type="email" id="correo" placeholder="Correo Electrónico">
<input type="password" id="password" placeholder="Contraseña">
<input type="password" id="confirmar" placeholder="Confirmar Contraseña">

    </div>
<button id="registrarBtn" class="btn">Registrarse</button>

    <a href="index.html">
    <div class="reg">
    <h3>Regresar</h3>
</div>
</a>
</div>

    <script>
        function toggleForm() {
            var form = document.getElementById("formPersonal");
            if (form.style.display === "none" || form.style.display === "") {
                form.style.display = "block";
                setTimeout(() => {
                    form.style.opacity = "1";
                    form.style.maxHeight = "500px";
                }, 10);
            } else {
                form.style.opacity = "0";
                form.style.maxHeight = "0";
                setTimeout(() => {
                    form.style.display = "none";
                }, 500);
            }
        }
    </script>
    <script src="js/pac.js"></script>
<script type="module">
  import { initializeApp, getApps, initializeApp as initApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAofOyGzsSWHQG3FfsFrGbVWjW0xMywb9c",
    authDomain: "doctrack-46fc2.firebaseapp.com",
    projectId: "doctrack-46fc2",
    storageBucket: "doctrack-46fc2.firebasestorage.app",
    messagingSenderId: "865552814891",
    appId: "1:865552814891:web:cf8e79d5ffd847067bab6e",
    measurementId: "G-XQPNKXK08Y"
  };

  // Inicializar apps
  const mainApp = initializeApp(firebaseConfig);
  const mainAuth = getAuth(mainApp); // Sesión del doctor
  const db = getFirestore(mainApp);

  // App secundaria para registrar pacientes
  const secondApp = getApps().find(app => app.name === "Secondary") || initApp(firebaseConfig, "Secondary");
  const secondaryAuth = getAuth(secondApp);

  // Función para asignar paciente al doctor
  async function asignarPacienteADoctor(idDoctor, idPaciente) {
    const doctorRef = doc(db, "doctores", idDoctor);
    await updateDoc(doctorRef, {
      [`pacientes.${idPaciente}`]: true
    });
    console.log("✅ Paciente asignado al doctor.");
  }

  // Evento al hacer clic en "Registrarse"
  document.getElementById("registrarBtn").addEventListener("click", async () => {
    const nombre = document.getElementById("nombre").value.trim();
    const paterno = document.getElementById("paterno").value.trim();
    const materno = document.getElementById("materno").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const curp = document.getElementById("curp")?.value.trim() || "sin-curp";
    const nacimiento = document.getElementById("nacimiento")?.value || "2000-01-01";
    const password = document.getElementById("password").value;
    const confirmar = document.getElementById("confirmar").value;

    if (!nombre || !paterno || !materno || !correo || !password || !confirmar) {
      alert("⚠️ Todos los campos son obligatorios.");
      return;
    }

    if (password !== confirmar) {
      alert("⚠️ Las contraseñas no coinciden.");
      return;
    }

    try {
      const doctorId = mainAuth.currentUser?.uid;

      if (!doctorId) {
        alert("❌ No hay sesión activa del doctor.");
        return;
      }

      // 1. Crear el paciente con secondaryAuth
      const cred = await createUserWithEmailAndPassword(secondaryAuth, correo, password);
      const pacienteId = cred.user.uid;

      // 2. Cerrar sesión del paciente para que el doctor quede como request.auth
      await signOut(secondaryAuth);

      // 3. Guardar documento del paciente desde la sesión del doctor
      await setDoc(doc(db, "usuarios", pacienteId), {
        nombre,
        paterno,
        materno,
        correo,
        curp,
        nacimiento,
        password,
        rol: "paciente",
        assignedDoctor: doctorId
      });

      // 4. Asignar paciente en el documento del doctor
      await asignarPacienteADoctor(doctorId, pacienteId);

      alert("✅ Paciente registrado y asignado correctamente.");
      window.location.href = "Paciente.html";
      
    } catch (error) {
      console.error("❌ Error al registrar paciente:", error);
      alert("❌ Error al registrar paciente: " + error.message);
    }
  });
</script>



</body>
</html>